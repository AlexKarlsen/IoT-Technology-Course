\subsection{Server}
The server is the entity that binds the solution together. It communicates with the devices trough MQTT protocol, and serves as a REST API to the device and the application. and sits in front of the database, responsible for reading and writing data from the IoT device and the Apllication. \\\\ The server handles communication with the IoT Device through the MQTT broker. 
The server exposes services to the device and the application. The REST API exposes a service to the device to get it's own setting. This service is used upon start-up to get updates, that happened while the device was offline. 
The REST API exposes also services to get all telemetry data, and to get telemetry data filtered for a single device and to establish a live stream of device data. 
The REST API exposes services to the application. Services as; to get all the devices, to get a device's settings,to update a device thresholds and to get live stream of device events. The exposed HTTP endpoints can be found in API tables after the tables the services of the API are elaborated upon. Table \ref{tbl:device} presents the device endpoints. 

\begin{table}[H]
    \centering
    \begin{tabular}{|l|l|l|}
    \hline
    \textbf{HTTP Method}    & \textbf{API Route} & \textbf{Response} \\ \hline
    Get & /Device/:id & Device's settings  \\ \hline
    \end{tabular}
    \caption{REST Endpoint Device}
    \label{tbl:device}
\end{table}
The server also exposes HTTP REST Endpoint for applications to get telemetry data from devices as seen in table \ref{tbl:telemetry}.

\begin{table}[H]
    \centering
    \begin{tabular}{|l|l|p{5cm}|}
    \hline
    \textbf{HTTP Method}    & \textbf{API Route} & \textbf{Response} \\ \hline
    Get & /Telemetry & All Sensor Telemetry  \\ \hline
    Get & /Telemetry/:id & Sensor Telemetry by device \\ \hline
    Stream & /Telemetry/stream & Live SSE Sensor Telemetry  \\ \hline
    \end{tabular}
    \caption{REST Endpoint Telemetry}
    \label{tbl:telemetry}
\end{table}
The server exposes HTTP REST endpoint service to manage devices and subscribe to the reports and alerts stream as seen in table \ref{tbl:service}.

    \begin{table}[H]
        \centering
        \begin{tabular}{|l|l|p{5cm}|}
        \hline
        \textbf{HTTP Method}    & \textbf{API Route} & \textbf{Response} \\ \hline
        Get & /Service/Device & List of all devices  \\ \hline
        Get & /Service/Device:id & Device's Setting \\ \hline
        Put & /Service/Device/:id/Threshold/:type & Update Threshold Value for device by type  \\ \hline
        Stream & /Service/Device/Stream & Live SSE Reports and Alerts \\ \hline
        \end{tabular}
        \caption{REST Endpoint Service}
        \label{tbl:service}
    \end{table}

    Node.js Express Framework provides a way of nicely constructing the API routes and separate the logic into controllers in a MVC-like pattern returning JSON data instead of rendered views. File api/routes/serviceRoutes.js presented in listing \ref{lst:routes} show the routing structure of the REST API Service Endpoint. 

\begin{lstlisting}[style=js, caption=Node.js REST API Routes, label={lst:routes}]
    ...
    var baseurl = '/service';

    /* REST API routes */
    router.route(baseurl + '/device')
        .get(serviceController.getDevices);

    router.route(baseurl + '/device/:id')
        .get(serviceController.getDeviceSetting);

    router.route(baseurl + '/device/:id' + '/thresholds' + '/:type')
        .put(serviceController.updateDeviceSetting);

    router.route(baseurl + '/stream')
        .get(serviceController.deviceStream); 
    ...
\end{lstlisting}

The server enables live stream features by implementing the Server-Sent-Event (SSE) pattern. SSE is an altered HTTP Get Method, where the connection is kept alive. The server sends events event over this open connection to applications, that utilizes this channel and live updates the UI. Below listing \ref{lst:sse} shows how it is implemented.

\begin{lstlisting}[style=js, caption=Server Sent Event, label={lst:sse}]
    router.get('/api/telemetry/stream', function (req, res) {
    // send headers for event-stream connection
    res.writeHead(200, {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    });

    var topic = "telemetry";
    client.subscribe(topic, function () {
      client.on('message', function (topic, msg, pkt) {
        res.write("data: " + msg + '\n\n');
      });
    });
  });
});
\end{lstlisting}

